let jsonData = [];

window.onload = loadData;

function loadData() {
    const file = '4IshwarApp.xlsx';
    fetch(file).then(response => {
        if (response.ok) return response.blob();
        else throw new Error('File not found');
    }).then(blob => {
        const fileReader = new FileReader();
        fileReader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            jsonData = XLSX.utils.sheet_to_json(sheet);
            document.getElementById('recordCount').textContent = `Number of records: ${jsonData.length}`;
            console.log('Data loaded:', jsonData); // Debugging log
        };
        fileReader.readAsArrayBuffer(blob);
    }).catch(error => {
        console.error('Error loading file:', error);
        document.getElementById('recordCount').textContent = 'Error loading data';
    });
}

function onInputChange() {
    const searchBar = document.getElementById('searchBar');
    const input = searchBar.value.toLowerCase();
    console.log('Input changed:', input); // Debugging log

    if (input.length >= 3) {
        search(input);
    } else {
        showInitialMessage();
    }
}

function search(input) {
    console.log('Performing search on input:', input); // Debugging log
    const results = jsonData.filter(item => {
        console.log('Checking item:', item); // Debugging log
        return item.SEARCH && item.SEARCH.toString().toLowerCase().includes(input);
    });
    console.log('Search results:', results); // Debugging log

    results.forEach(result => {
        result.totalMatches = (result.SEARCH.toString().toLowerCase().match(new RegExp(input, 'g')) || []).length;
    });

    results.sort((a, b) => b.totalMatches - a.totalMatches);

    const resultsTable = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
    resultsTable.innerHTML = '';

    if (results.length === 0) {
        resultsTable.innerHTML = '<tr><td colspan="9">No records found.</td></tr>';
    } else {
        results.forEach(result => {
            const row = resultsTable.insertRow();

            row.insertCell().innerHTML = highlightMatch(result.BRAND, input);
            row.insertCell().innerHTML = highlightMatch(result.COMPANY, input);
            row.insertCell().textContent = result.PACK || 'N/A';
            row.insertCell().textContent = isNumeric(result.RATE) ? Number(result.RATE).toFixed(2) : 'N/A';
            row.insertCell().textContent = isNumeric(result["Free Scheme"]) ? Number(result["Free Scheme"]).toFixed(2) : 'N/A';
            row.insertCell().textContent = isNumeric(result.MRP) ? Number(result.MRP).toFixed(2) : 'N/A';
            row.insertCell().innerHTML = highlightMatch(result.CONTENT, input);
            row.insertCell().textContent = result.CASE || 'N/A';
            row.insertCell().textContent = result.totalMatches;
        });
    }
}

function resetSearch() {
    document.getElementById('searchBar').value = '';
    showInitialMessage();
}

function showInitialMessage() {
    const resultsTable = document.getElementById('resultsTable').getElementsByTagName('tbody')[0];
    resultsTable.innerHTML = '<tr><td colspan="9">Waiting for input...</td></tr>';
}

function isNumeric(value) {
    return !isNaN(parseFloat(value)) && isFinite(value);
}

function highlightMatch(text, input) {
    if (!text) return 'N/A';
    const regex = new RegExp(`(${input})`, 'gi');
    return text.toString().replace(regex, '<span class="highlight">$1</span>');
}

    </script>
</body>
</html>
